<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leistungsnachweis Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #030213;
            --primary-foreground: #ffffff;
            --background: #f9fafb;
            --card: #ffffff;
            --border: rgba(0, 0, 0, 0.1);
            --input-background: #f3f3f5;
            --muted-foreground: #717182;
            --destructive: #d4183d;
            --radius: 0.625rem;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: var(--background);
            color: #1f2937;
            line-height: 1.5;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.3;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.3;
        }

        h3 {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.3;
        }

        label {
            font-size: 0.8125rem;
            font-weight: 500;
            display: block;
            margin-bottom: 0.25rem;
        }

        input, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 2px);
            background-color: var(--input-background);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--primary);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--primary);
        }

        .btn-ghost:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .btn-icon {
            padding: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            justify-content: center;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .container {
            min-height: 100vh;
            padding: 1rem;
        }

        .max-w-6xl {
            max-width: 72rem;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .card-description {
            font-size: 0.8125rem;
            color: var(--muted-foreground);
        }

        .card-content {
            padding: 1rem;
        }

        .grid {
            display: grid;
            gap: 0.75rem;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .text-center {
            text-align: center;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .hidden {
            display: none;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(to bottom right, #eff6ff, #f3f4f6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .login-card {
            width: 100%;
            max-width: 28rem;
        }

        .login-icon {
            width: 4rem;
            height: 4rem;
            background-color: #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        /* Radio Group */
        .radio-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            border-color: var(--primary);
            background-color: rgba(3, 2, 19, 0.05);
        }

        .radio-label:hover {
            border-color: #d1d5db;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            font-size: 0.8125rem;
        }

        .table-container {
            overflow-x: auto;
        }

        /* Signature Pad */
        .signature-canvas {
            width: 100%;
            border: 2px solid #d1d5db;
            border-radius: calc(var(--radius) - 2px);
            cursor: crosshair;
            background-color: white;
            touch-action: none;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 9999;
        }

        .toast {
            background-color: var(--card);
            color: var(--primary);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background-color: #10b981;
            color: white;
        }

        .toast.error {
            background-color: var(--destructive);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .radio-group {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }
        }

        /* Icons (simple SVG-based) */
        .icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .w-full {
            width: 100%;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .pt-4 {
            padding-top: 1rem;
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .border-t {
            border-top: 1px solid var(--border);
        }

        .bg-gray-100 {
            background-color: #f3f4f6;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .rounded-md {
            border-radius: calc(var(--radius) - 2px);
        }

        /* Custom Select Styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.625rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem;
        }

        .signature-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="card login-card">
            <div class="card-header text-center">
                <div class="login-icon">
                    <svg class="icon" style="width: 2rem; height: 2rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <h2 class="card-title">Leistungsnachweis Generator</h2>
                <p class="card-description">Talk&Phone GmbH</p>
            </div>
            <div class="card-content">
                <form id="loginForm" class="space-y-4">
                    <div class="space-y-2">
                        <label for="password">Passwort</label>
                        <input type="password" id="password" placeholder="Passwort eingeben" autofocus>
                    </div>
                    <button type="submit" class="btn-primary w-full">Anmelden</button>
                </form>
                <p class="text-xs text-gray-500 mt-4 text-center">
                    Bitte geben Sie Ihr Passwort ein, um auf den Leistungsnachweis Generator zuzugreifen.
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <div class="max-w-6xl">
            <div class="text-center space-y-2" style="margin-bottom: 1.5rem;">
                <h1>Leistungsnachweis Generator</h1>
                <p class="text-gray-600">Erstellen Sie professionelle Leistungsnachweise als PDF</p>
            </div>

            <!-- Kundendaten -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Kundendaten</h3>
                    <p class="card-description">Informationen zum Kunden</p>
                </div>
                <div class="card-content space-y-4">
                    <div class="grid grid-cols-2">
                        <div class="space-y-2">
                            <label for="kundenName">Vollständiger Name</label>
                            <input type="text" id="kundenName" placeholder="z.B. Max Mustermann">
                        </div>
                        <div class="space-y-2">
                            <label for="kundenEmail">E-Mail-Adresse</label>
                            <input type="email" id="kundenEmail" placeholder="z.B. max@beispiel.de">
                        </div>
                        <div class="space-y-2">
                            <label for="kundenStrasse">Straße und Hausnummer</label>
                            <input type="text" id="kundenStrasse" placeholder="z.B. Musterstraße 123">
                        </div>
                        <div class="space-y-2">
                            <label for="kundenPlzOrt">PLZ und Ort</label>
                            <input type="text" id="kundenPlzOrt" placeholder="z.B. 10115 Berlin">
                        </div>
                        <div class="space-y-2">
                            <label for="kundenTelefon">Telefonnummer</label>
                            <input type="tel" id="kundenTelefon" placeholder="z.B. +49 30 12345678">
                        </div>
                    </div>

                    <div class="space-y-2 pt-2">
                        <label>Zahlungsart</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="zahlungsart" id="bar" value="bar" checked>
                                <label for="bar" class="radio-label">Barzahlung</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="zahlungsart" id="karte" value="karte">
                                <label for="karte" class="radio-label">Kartenzahlung</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="zahlungsart" id="rechnung" value="rechnung">
                                <label for="rechnung" class="radio-label">Rechnung</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auftragsinformationen -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Auftragsinformationen</h3>
                    <p class="card-description">Auftragsnummer und Zeitraum</p>
                </div>
                <div class="card-content space-y-4">
                    <div class="grid grid-cols-2">
                        <div class="space-y-2">
                            <label for="projektnummer">Auftragsnummer</label>
                            <input type="text" id="projektnummer" placeholder="z.B. AUF-2025-001">
                        </div>
                        <div class="space-y-2">
                            <label for="technikerName">Name des Technikers</label>
                            <input type="text" id="technikerName" placeholder="z.B. Max Müller">
                        </div>
                        <div class="space-y-2">
                            <label for="monat">Monat</label>
                            <input type="text" id="monat" placeholder="z.B. November">
                        </div>
                        <div class="space-y-2">
                            <label for="jahr">Jahr</label>
                            <input type="number" id="jahr" placeholder="2025">
                        </div>
                        <div class="space-y-2">
                            <label for="firma">Firma</label>
                            <select id="firma">
                                <option value="alsleben">IT Systemhaus Alsleben GmbH - Treskowallee 114, 10319 Berlin</option>
                                <option value="talkphone">Talk & Phone GmbH - Treskowallee 114, 10319 Berlin</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Erbrachte Leistungen -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Erbrachte Leistungen</h3>
                    <p class="card-description">Tragen Sie hier die einzelnen Leistungspositionen ein</p>
                </div>
                <div class="card-content space-y-4">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 140px;">Datum</th>
                                    <th>Beschreibung der Leistung</th>
                                    <th style="width: 120px;">Stunden</th>
                                    <th style="width: 80px;"></th>
                                </tr>
                            </thead>
                            <tbody id="leistungenTable">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t" style="flex-wrap: wrap; gap: 1rem;">
                        <button class="btn-outline" onclick="addLeistung()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Weitere Leistung hinzufügen
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600">Gesamtstunden:</span>
                            <span class="px-4 py-2 bg-gray-100 rounded-md" id="gesamtStunden">0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unterschriften -->
            <div class="grid grid-cols-2">
                <!-- Techniker Unterschrift -->
                <div class="card">
                    <div class="card-header">
                        <div class="signature-header">
                            <div>
                                <h3 class="card-title">Unterschrift Techniker</h3>
                                <p class="card-description">Unterschrift des Technikers zur Bestätigung der erbrachten Leistungen</p>
                            </div>
                            <button class="btn-ghost btn-icon hidden" id="clearTechnikerBtn" onclick="clearSignature('techniker')">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <canvas id="technikerCanvas" class="signature-canvas" width="600" height="200"></canvas>
                        <p class="text-sm text-gray-500 mt-3">
                            Unterschreiben Sie mit der Maus oder per Berührung auf dem Touchscreen
                        </p>
                    </div>
                </div>

                <!-- Kunden Unterschrift -->
                <div class="card">
                    <div class="card-header">
                        <div class="signature-header">
                            <div>
                                <h3 class="card-title">Unterschrift Kunde</h3>
                                <p class="card-description">Unterschrift des Kunden zur Bestätigung der erbrachten Leistungen</p>
                            </div>
                            <button class="btn-ghost btn-icon hidden" id="clearKundeBtn" onclick="clearSignature('kunde')">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <canvas id="kundeCanvas" class="signature-canvas" width="600" height="200"></canvas>
                        <p class="text-sm text-gray-500 mt-3">
                            Unterschreiben Sie mit der Maus oder per Berührung auf dem Touchscreen
                        </p>
                    </div>
                </div>
            </div>

            <!-- Export Button -->
            <div class="flex justify-center" style="margin-top: 1.5rem;">
                <button class="btn-primary" onclick="exportToPDF()" id="exportBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Als PDF exportieren
                </button>
            </div>
        </div>
    </div>

    <script>

        // Toast System
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success' 
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                    }
                </svg>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Login
        const CORRECT_PASSWORD = 'P9TM!';
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;

            if (password === CORRECT_PASSWORD) {
                showToast('Erfolgreich angemeldet, bitte scrollen!');
                setTimeout(() => {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    initializeApp();
                }, 1000);
            } else {
                showToast('Falsches Passwort!', 'error');
                document.getElementById('password').value = '';
            }
        });

        // App State
        let leistungen = [];
        let nextId = 1;
        const FIRMEN = {
            alsleben: {
                firma: 'IT Systemhaus Alsleben GmbH',
                strasse: 'Treskowallee 114',
                plzOrt: '10319 Berlin'
            },
            talkphone: {
                firma: 'Talk & Phone GmbH',
                strasse: 'Treskowallee 114',
                plzOrt: '10319 Berlin'
            }
        };

        function initializeApp() {
            // Set current year
            document.getElementById('jahr').value = new Date().getFullYear();
            
            // Add initial row
            addLeistung();

            // Initialize signature pads
            initSignaturePad('technikerCanvas', 'clearTechnikerBtn');
            initSignaturePad('kundeCanvas', 'clearKundeBtn');
        }

        // Leistungen Management
        function addLeistung() {
            const id = nextId++;
            leistungen.push({ id, datum: '', beschreibung: '', stunden: '' });
            renderLeistungen();
        }

        function removeLeistung(id) {
            if (leistungen.length > 1) {
                leistungen = leistungen.filter(l => l.id !== id);
                renderLeistungen();
            }
        }

        function updateLeistung(id, field, value) {
            const leistung = leistungen.find(l => l.id === id);
            if (leistung) {
                leistung[field] = value;
                updateGesamtStunden();
            }
        }

        function renderLeistungen() {
            const tbody = document.getElementById('leistungenTable');
            tbody.innerHTML = leistungen.map(l => `
                <tr>
                    <td>
                        <input type="date" value="${l.datum}" 
                            onchange="updateLeistung(${l.id}, 'datum', this.value)">
                    </td>
                    <td>
                        <input type="text" value="${l.beschreibung}" 
                            placeholder="z.B. Frontend-Entwicklung, Meeting, etc."
                            onchange="updateLeistung(${l.id}, 'beschreibung', this.value)">
                    </td>
                    <td>
                        <input type="number" step="0.5" min="0" value="${l.stunden}" 
                            placeholder="0.0"
                            onchange="updateLeistung(${l.id}, 'stunden', this.value)">
                    </td>
                    <td>
                        <button class="btn-ghost btn-icon" 
                            onclick="removeLeistung(${l.id})"
                            ${leistungen.length === 1 ? 'disabled' : ''}>
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
            updateGesamtStunden();
        }

        function updateGesamtStunden() {
            const total = leistungen.reduce((sum, l) => {
                return sum + (parseFloat(l.stunden) || 0);
            }, 0);
            document.getElementById('gesamtStunden').textContent = total.toFixed(2);
        }

        // Signature Pad
        let signatureData = {
            techniker: null,
            kunde: null
        };

        function initSignaturePad(canvasId, clearBtnId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const clearBtn = document.getElementById(clearBtnId);
            let isDrawing = false;
            let hasSignature = false;

            const type = canvasId.includes('techniker') ? 'techniker' : 'kunde';

            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                let x, y;
                if (e.touches) {
                    x = (e.touches[0].clientX - rect.left) * scaleX;
                    y = (e.touches[0].clientY - rect.top) * scaleY;
                } else {
                    x = (e.clientX - rect.left) * scaleX;
                    y = (e.clientY - rect.top) * scaleY;
                }
                return { x, y };
            }

            function startDrawing(e) {
                isDrawing = true;
                hasSignature = true;
                clearBtn.classList.remove('hidden');
                
                const { x, y } = getCoordinates(e);
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function draw(e) {
                if (!isDrawing) return;
                if (e.touches) e.preventDefault();

                const { x, y } = getCoordinates(e);
                ctx.lineTo(x, y);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }

            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    if (hasSignature) {
                        signatureData[type] = canvas.toDataURL('image/png');
                    }
                }
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function clearSignature(type) {
            const canvasId = type === 'techniker' ? 'technikerCanvas' : 'kundeCanvas';
            const clearBtnId = type === 'techniker' ? 'clearTechnikerBtn' : 'clearKundeBtn';
            
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            signatureData[type] = null;
            document.getElementById(clearBtnId).classList.add('hidden');
        }

        // PDF Export
        async function exportToPDF() {
            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="icon spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Wird erstellt...
            `;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;

            // Daten sammeln
            const kundenName = document.getElementById('kundenName').value;
            const kundenEmail = document.getElementById('kundenEmail').value;
            const kundenStrasse = document.getElementById('kundenStrasse').value;
            const kundenPlzOrt = document.getElementById('kundenPlzOrt').value;
            const kundenTelefon = document.getElementById('kundenTelefon').value;
            const projektnummer = document.getElementById('projektnummer').value;
            const technikerName = document.getElementById('technikerName').value;
            const monat = document.getElementById('monat').value;
            const jahr = document.getElementById('jahr').value;
            const selectedFirma = document.getElementById('firma').value;
            const firmaInfo = FIRMEN[selectedFirma];
            const zahlungsart = document.querySelector('input[name="zahlungsart"]:checked').value;
            const zahlungsartText = {
                bar: 'Barzahlung',
                karte: 'Kartenzahlung',
                rechnung: 'Rechnung'
            }[zahlungsart];

            // Titel
            doc.setFontSize(20);
            doc.text('Leistungsnachweis', pageWidth / 2, 20, { align: 'center' });

            // Techniker-Informationen (links)
            doc.setFontSize(10);
            let yPos = 35;
            doc.text('Techniker:', 20, yPos);
            yPos += 5;
            if (technikerName) {
                doc.text(technikerName, 20, yPos);
                yPos += 5;
            }
            if (firmaInfo) {
                doc.text(firmaInfo.firma, 20, yPos);
                yPos += 5;
                doc.text(firmaInfo.strasse, 20, yPos);
                yPos += 5;
                doc.text(firmaInfo.plzOrt, 20, yPos);
            }

            // Kundendaten (rechts)
            yPos = 35;
            doc.text('Kunde:', pageWidth - 85, yPos);
            yPos += 5;
            doc.text(kundenName || '-', pageWidth - 85, yPos);
            yPos += 5;
            doc.text(kundenStrasse || '-', pageWidth - 85, yPos);
            yPos += 5;
            doc.text(kundenPlzOrt || '-', pageWidth - 85, yPos);
            yPos += 5;
            doc.text(`Tel: ${kundenTelefon || '-'}`, pageWidth - 85, yPos);
            yPos += 5;
            doc.text(`E-Mail: ${kundenEmail || '-'}`, pageWidth - 85, yPos);

            // Projekt-Informationen
            yPos = 75;
            doc.setFontSize(12);
            doc.text(`Auftragsnummer: ${projektnummer || '-'}`, 20, yPos);
            yPos += 7;
            doc.text(`Zeitraum: ${monat || '-'} ${jahr || '-'}`, 20, yPos);
            yPos += 7;
            doc.text(`Zahlungsart: ${zahlungsartText}`, 20, yPos);
            yPos += 15;

            // Tabelle Header
            doc.setFillColor(240, 240, 240);
            doc.rect(20, yPos - 5, pageWidth - 40, 10, 'F');
            doc.setFontSize(11);
            doc.text('Datum', 25, yPos);
            doc.text('Beschreibung', 60, yPos);
            doc.text('Stunden', pageWidth - 35, yPos);

            yPos += 10;

            // Tabelle Einträge
            doc.setFontSize(10);
            leistungen.forEach(eintrag => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.text(eintrag.datum || '-', 25, yPos);

                const beschreibung = eintrag.beschreibung || '-';
                const maxWidth = 80;
                const lines = doc.splitTextToSize(beschreibung, maxWidth);
                doc.text(lines, 60, yPos);

                doc.text(eintrag.stunden || '0', pageWidth - 35, yPos);

                yPos += Math.max(7, lines.length * 5);
            });

            // Summe
            yPos += 5;
            doc.setDrawColor(0);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 7;
            doc.setFontSize(11);
            const gesamtStunden = document.getElementById('gesamtStunden').textContent;
            doc.text(`Gesamtstunden: ${gesamtStunden}`, pageWidth - 60, yPos);

            // Unterschriften
            yPos += 20;
            if (yPos > 220) {
                doc.addPage();
                yPos = 40;
            }

            // Unterschrift Techniker
            if (signatureData.techniker) {
                doc.addImage(signatureData.techniker, 'PNG', 20, yPos, 60, 20);
            } else {
                doc.line(20, yPos + 20, 80, yPos + 20);
            }

            // Unterschrift Kunde
            if (signatureData.kunde) {
                doc.addImage(signatureData.kunde, 'PNG', pageWidth - 80, yPos, 60, 20);
            } else {
                doc.line(pageWidth - 80, yPos + 20, pageWidth - 20, yPos + 20);
            }

            yPos += 25;
            doc.setFontSize(9);
            doc.text('Datum, Unterschrift Techniker', 20, yPos);
            doc.text('Datum, Unterschrift Kunde', pageWidth - 80, yPos);

            // PDF speichern
            const filename = `Leistungsnachweis_${kundenName || 'Kunde'}_${monat || ''}_${jahr}.pdf`.replace(/\s+/g, '_');
            doc.save(filename);

            showToast('PDF wurde erfolgreich erstellt!');
            
            btn.disabled = false;
            btn.innerHTML = `
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Als PDF exportieren
            `;
        }
    </script>
</body>
</html>